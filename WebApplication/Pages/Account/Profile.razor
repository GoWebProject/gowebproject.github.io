@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Components.Web;
@page "/Profile"
@using Microsoft.JSInterop;
@using WebApplication.Models;
@inject IJSRuntime JsRuntime;
@inject NavigationManager _navigationManager

<form>
    <div readonly>
        <label for="name">Имя пользователя:</label><br>
        <input style="width: auto; @(madeAttempt && username.Length == 0 ? "border-color:red;" : "");" class="form-control input_user" @bind="username" type="text" id="username" @attributes="@(disable_fields ? readOnlyAttr : notReadOnlyAttr)"><br><br>
        <label for="secondname">Полное Имя:</label><br>
        <input style="width: auto;@(madeAttempt && fullname.Length == 0 ? "border-color:red;" : "");" class="form-control input_user" @bind="fullname" type="text" id="fullname" @attributes="@(disable_fields ? readOnlyAttr : notReadOnlyAttr)"><br><br>
        <label for="login">Почта:</label><br>
        <input style="width: auto; @(madeAttempt && email.Length == 0 && email.Contains('@') ? "border-color:red;" : "");" class="form-control input_user" @bind="email" type="text" id="email" @attributes="@(disable_fields ? readOnlyAttr : notReadOnlyAttr)"><br><br>
        <label for="racing">РФГ рейтинг:</label><br>
        <input style="width: auto; @(madeAttempt @*&& _pwd.Length == 0*@ ? "border-color:red;" : "");" class="form-control input_user" @bind="rating" type="text" id="rating" @attributes="@(disable_fields ? readOnlyAttr : notReadOnlyAttr)"><br><br>
        <label for="misc_racing">Другие рейтинги:</label><br>
        <input style="width: auto; " class="form-control input_user" @bind="misc_rating" type="text" id="misc_rating" @attributes="@(disable_fields ? readOnlyAttr : notReadOnlyAttr)"><br><br>
    </div>
</form>
<div class="mt-4">
    <div class="d-flex links">
        Нет аккаунта? <a href="/Account/Registration" class="ml-2">Сменить пароль</a>
    </div>
</div>
<button class="btn btn-primary" @onclick="OnSubmitButtonClick">@buttonLabel</button>

@code{
    private bool disable_fields = true;
    private bool madeAttempt = true;
    private string username = "";
    private string old_username = "";
    private string fullname = "";
    private string email = "";
    private string _pwd = "";
    private string buttonLabel = "Изменить данные";
    private int rating = 1500;
    private string misc_rating = "";
    private List<KeyValuePair<string, object>> readOnlyAttr = new List<KeyValuePair<string, object>>() { new KeyValuePair<string, object>("readonly", "") };
    private List<KeyValuePair<string, object>> notReadOnlyAttr = new List<KeyValuePair<string, object>>() { };


    protected override Task OnInitializedAsync()
    {
        var uname = CookieManager.ReadCookies(JsRuntime, "username");
        var user = UserManager.GetUser(uname.Result);
        username = user.Username;
        old_username = username;
        fullname = user.FullName;
        email = user.Email;
        rating = user.RFG_rating;
        misc_rating = user.Misc_rating;

        return base.OnInitializedAsync();
    }

    void OnSubmitButtonClick()
    {
        if (disable_fields) {
            disable_fields = false;
            buttonLabel = "Сохранить изменения";

        }

        else
        {
            var change_user = false;
            if ((username.Length > 0) && (fullname.Length > 0) && (email.Length > 0) && (_pwd.Length > 0) && (email.Contains('@')))
            {
                change_user = UserManager.ChangeUser(old_username,new User(username, email, _pwd, fullname));
                if (!change_user)
                {
                    JsRuntime.InvokeVoidAsync("alert", "Пользователь с таким именем есть");
                    username = "";
                }

            }
            else
            {
                if (!email.Contains('@') && (email.Length > 0))
                {
                    JsRuntime.InvokeVoidAsync("alert", "Email должен сожержать знак @");
                }
                else
                {
                    JsRuntime.InvokeVoidAsync("alert", "Заполните соответствующие поля!");
                }

                madeAttempt = true;
            }
            if (change_user)
            {
                disable_fields = true;
                buttonLabel = "Изменить данные";
                JsRuntime.InvokeVoidAsync("alert", "Данные изменены!");
            }
        }
    }


}